# GitHub Actions CI/CD for Vinted Optimizer
# Triggers on push to main/develop and on PRs

name: CI/CD

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

env:
  PYTHON_VERSION: "3.12"
  NODE_VERSION: "20"

jobs:
  # ============================================
  # API Service - Lint, Test, Build
  # ============================================
  api-lint:
    name: API - Lint & Type Check
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: services/api
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: services/api/pyproject.toml
      
      - name: Install dependencies
        run: uv pip install --system -e .
      
      - name: Run Ruff linter
        run: ruff check src/
      
      - name: Run Ruff formatter check
        run: ruff format --check src/
      
      - name: Run MyPy type check
        run: mypy src/ --ignore-missing-imports
        continue-on-error: true

  api-test:
    name: API - Tests
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: services/api
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: services/api/pyproject.toml
      
      - name: Install dependencies
        run: uv pip install --system -e .
      
      - name: Run tests with coverage
        run: pytest --cov=src --cov-report=xml --cov-report=term-missing || true
        env:
          DATABASE_URL: postgresql+asyncpg://test:test@localhost:5432/test
          REDIS_URL: redis://localhost:6379/0
          SECRET_KEY: test-secret-key-for-ci

  # ============================================
  # Frontend - Lint, Build
  # ============================================
  frontend-lint:
    name: Frontend - Lint & Build
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: services/frontend
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: services/frontend/package-lock.json
      
      - name: Install dependencies
        run: npm ci || npm install
      
      - name: Run Biome lint
        run: npx biome check . || true
      
      - name: Build Next.js
        run: npm run build
        env:
          NEXT_TELEMETRY_DISABLED: 1

  # ============================================
  # Deploy to Fly.io (main branch only)
  # ============================================
  deploy-api:
    name: Deploy API to Fly.io
    runs-on: ubuntu-latest
    needs: [api-lint, api-test]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    defaults:
      run:
        working-directory: services/api
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Fly.io
        uses: superfly/flyctl-actions/setup-flyctl@master
      
      - name: Deploy to Fly.io
        run: flyctl deploy --remote-only
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}

  # ============================================
  # Security Scan
  # ============================================
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          severity: 'CRITICAL,HIGH'
          exit-code: '0'  # Don't fail on vulnerabilities
          format: 'table'
